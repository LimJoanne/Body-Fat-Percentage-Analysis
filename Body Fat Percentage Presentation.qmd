---
title: "Body Fat Percentage Presentation"
subtitle: "Group 013E01"
author: "Joanne Lim, John Fu, Haoyuan Gao, Zhenchen Yi"
format:
  revealjs:
    # self-contained: true
    fig-format: retina
    toc: true
    toc-depth: 1
    number-sections: false
    toc-title: "In this lecture"
    theme: [default, "sydney.scss"]
    code-line-numbers: false
    embed-resources: true
    slide-number: c
    scrollable: true
    smaller: true
    pdf-max-pages-per-slide: 1
    history: false # don't add each slide to browser history
    auto-slide: 20000
bibliography: pres_bib.bib
csl: apa-old-doi-prefix.csl
execute:
  echo: false
---

## Data Description

-   Accurately body fat measurement is vital but often inconvenient and expensive
-   Can we use simpler measurements like height, weight, and circumferences for estimates?
-   The data set [bodyfat](https://dasl.datadescription.com/datafile/bodyfat) contains body fat percentages and other related measurements for 250 men. These measurements, which include height, weight and various body circumferences, were collected to explore alternatives to underwater body fat assessments.

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(ggplot2)
bodyfat <- read.table("bodyfat.txt", header = TRUE)
glimpse(bodyfat)
library(stats)
```


## Null and Full Model

```{r}
M0 = lm(Pct.BF ~ ., data = bodyfat) #full model
M1 = lm(Pct.BF ~ 1, data = bodyfat) #null model

summary(M0, data = bodyfat)
```

## Null and Full Model
```{r}
library(gt)
res = bind_rows(broom::glance(M0),
                broom::glance(M1))
res$model = c("M0", "M1")
res %>% pivot_longer(
  cols = -model,
  names_to = "metric",
  values_to = "value") %>% 
  pivot_wider(
    names_from = "model") %>% 
  gt::gt() %>% 
  gt::fmt_number(columns = 2:3,
                 decimals = 2) %>% 
  gt::fmt_missing()
```

## Backward stepwise selection

```{r}
step.back.aic = step(M0,
                     direction = "backward",
                     trace = FALSE)

summary(step.back.aic)
```

## Forward stepwise selection

```{r}
step.fwd.aic = step(M1, scope = list(lower = M1, upper = M0),
                    direction = "forward", trace = FALSE)
summary(step.fwd.aic)
```

## Summary of all models

```{r, warning=FALSE, message=FALSE}
library(sjPlot)
tab_model(M0, step.back.aic, step.fwd.aic, 
          dv.labels = c("Full", "Backward", "Forward"),
          show.ci = F, show.aic = T)

```

## Model selection conclusion

- Generally, higher values of R-squared are better, but a very high R-squared could suggest overfitting, especially if it is much higher than the adjusted R-squared.
- Lower AIC values indicate a better-fitting model. 
- We can conclude from the table, backward selection model will be the most appropriate one as it has the lowest AIC values and its R-squared and adjusted R-squared is the same.

## Assumption checking: Pct.BF vs Age
```{r}
library(gridExtra)
lm1 = lm(Pct.BF ~ Density, data = bodyfat)
lm2 = lm(Pct.BF ~ Age, data = bodyfat)
lm3 = lm(Pct.BF ~ Abdomen, data = bodyfat)

#fitted values and residuals
bodyfat = bodyfat %>% 
  mutate(
    resid1 = lm1$residuals,
    fitted1 = lm1$fitted.values,
    resid2 = lm2$residuals,
    fitted2 = lm2$fitted.values,
    resid3 = lm3$residuals,
    fitted3 = lm3$fitted.values
  )
```

```{r}
p1 = bodyfat %>% ggplot() +
  aes(x = Density, y = Pct.BF)+
  geom_point(size=2) +
  labs(x = "Density",
       y = "Body Fat Percentage") +
  geom_smooth(method = "lm", se = FALSE)

p2 = bodyfat %>% ggplot() +
  aes(x = Density, y = resid1) +
  geom_point(size = 2) +
  labs(x = "Density",
       y = "Residual") +
  geom_hline(yintercept = 0)

p3 = bodyfat %>% ggplot() +
  aes(x = Age, y = Pct.BF)+
  geom_point(size=2) +
  labs(x = "Age",
       y = "Body Fat Percentage") +
  geom_smooth(method = "lm", se = FALSE)

p4 = bodyfat %>% ggplot() +
  aes(x = Age, y = resid2) +
  geom_point(size = 2) +
  labs(x = "Age",
       y = "Residual") +
  geom_hline(yintercept = 0)

p5 = bodyfat %>% ggplot() +
  aes(x = Abdomen, y = Pct.BF)+
  geom_point(size=2) +
  labs(x = "Abdomen",
       y = "Body Fat Percentage") +
  geom_smooth(method = "lm", se = FALSE)

p6 = bodyfat %>% ggplot() +
  aes(x = Abdomen, y = resid3) +
  geom_point(size = 2) +
  labs(x = "Abdomen",
       y = "Residual") +
  geom_hline(yintercept = 0)
```


```{r}
grid.arrange(p3, p4, ncol = 2)
```

## Assumption checking: Pct.BF vs Density


```{r}
grid.arrange(p1, p2, ncol = 2)
```


## Assumption checking: Pct.BF vs Abdomen


```{r}
grid.arrange(p5, p6, ncol = 2)
```


## Assumption checking for the model (1)

```{r}
library(ggfortify)
autoplot(step.back.aic, which = 1)
```

- **Linearity: **The residuals seem to be randomly scattered around the horizontal line. However, there are a few outliers (points labeled with numbers), but they don't appear to form a systematic pattern. Overall the assumption of linearity seems to be reasonably met.

- **Homoskedasticity: **The residuals don't appear to be fanning out or changing their variability over the range of the fitted values so the constant error variance assumption is met.

## Assumption checking for the model (2)

#### Independence

- The independence of error terms is crucial and typically addressed during the initial phases of experimental design, i.e. **before data collection**. Each variable is designed to maintain its independence and since each observation doesn't inherently influence another, we can conclude that they are independent of each other.

## Assumption checking for the model (3)

#### Check Normality
```{r}
autoplot(step.back.aic, which = 2)
```

- Apart from three points in the upper tail and one point in the lower tail, the majority of points lie quite close to the line in the QQ plot. Hence, the normality assumption for the residuals is reasonably well satisfied.

- Additionally, we have quite large sample size so we can also rely on the central limit theorem to give us approximately valid inferences.

## Final fitted model 
```{r}
step.back.aic
```

- Fitted model:
$$Pct.BF = 442.38 - 406.49 \times Density + 0.01 \times Age + 0.06 \times Abdomen$$

## Discussion of results
1. On average, holding the other variables constant, a year increase in age leads to a 0.01 increase in body fat percentage.
2. On average, holding the other variables constant, a 1cm increase in abdomen leads to a 0.06 increase in body fat percentage.
3. On average, holding the other variables constant, a unit increase in density leads to a decrease of 406.49 in body fat percentage.
4. When all predictor variables are set to zero, the expected body fat percentage is 442.38%. However, this interpretation might not be practically meaningful, especially if a value of zero for these predictors isn't feasible or meaningful in real-world scenarios.

## Cross Validation

This is the outcome of performance for our fitted model: $Pct.BF = 442.38 - 406.49 \times Density + 0.01 \times Age + 0.06 \times Abdomen$.

```{r}
n = nrow(bodyfat)
```

```{r}
library(caret)
cv_full = train(
  Pct.BF ~ Density + Age + Abdomen, bodyfat,
  method = "lm",
  trControl = trainControl(
    method = "cv", number = 10,
    verboseIter = FALSE
  )
)
cv_full
```

```{r}
cv_simple_density = train(
  Pct.BF ~ Density, bodyfat,
  method = "lm",
  trControl = trainControl(
    method = "cv", number = 10,
    verboseIter = FALSE
  )
)
```

```{r}
cv_simple_age = train(
  Pct.BF ~ Age, bodyfat,
  method = "lm",
  trControl = trainControl(
    method = "cv", number = 10,
    verboseIter = FALSE
  )
)
```

```{r}
cv_simple_abdomen = train(
  Pct.BF ~ Abdomen, bodyfat,
  method = "lm",
  trControl = trainControl(
    method = "cv", number = 10,
    verboseIter = FALSE
  )
)
```

## Summary of Cross Validation
```{r}
results <- resamples(list(simple_density = cv_simple_density,
                          simple_age = cv_simple_age,
                          simple_abdomen = cv_simple_abdomen,
                          full = cv_full))

g1 = ggplot(results, metric = "MAE") + labs(y = "MAE")
g2 = ggplot(results, metric = "RMSE") + labs(y = "RMSE")
g3 = ggplot(results, metric = "Rsquared") + labs(y = "Rsquared")

grid.arrange(g1, g2, g3, ncol = 1)
```

## Interpretation for Cross Validation
- Smaller RMSE and MAE value indicates better fit to the data.
- Higher values of R-squared are better.
- Comparing the full model with 3 simple model:
1. Simple_age and simple_abdomen has relatively higher MAE and RMSE value
2. Simple_density has the lowest Rsquared value.

Therefore, full($Pct.BF = 442.38 - 406.49 \times Density + 0.01 \times Age + 0.06 \times Abdomen$.) will be the best model.

## Limitation
- According to the linearity of Pct.BF abd age graph we can see there is one person which Pct.BF is 0, and the various age groups are not evenly distributed in the dataset. This may cause the deviation in the analyse.
- From the graph we can see that the Density almost perfom the same as the variable Pct.BF.